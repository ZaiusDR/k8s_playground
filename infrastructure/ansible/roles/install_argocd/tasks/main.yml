---
- name: Create ArgoCD Namespace
  kubernetes.core.k8s:
    name: "{{ argocd_namespace }}"
    api_version: v1
    kind: Namespace

- name: Install ArgoCD Non-HA
  kubernetes.core.k8s:
    src: "https://raw.githubusercontent.com/argoproj/argo-cd/v{{ argocd_version }}/manifests/install.yaml"
    namespace: "{{ argocd_namespace }}"

- name: Wait for ArgoCD to be ready
  ansible.builtin.wait_for:
    timeout: 60

- name: Create Traefik Namespace
  kubernetes.core.k8s:
    name: "{{ traefik_namespace }}"
    api_version: v1
    kind: Namespace

- name: Install Traefik Application
  kubernetes.core.k8s:
    definition:
      apiVersion: argoproj.io/v1alpha1
      kind: Application
      metadata:
        name: ingress-controller
        namespace: "{{ argocd_namespace }}"
      spec:
        project: default
        destination:
          server: https://kubernetes.default.svc
          namespace: "{{ traefik_namespace }}"
        sources:
          - repoURL: "https://traefik.github.io/charts"
            chart: traefik
            targetRevision: "{{ traefik_helm_version }}"
            helm:
              valueFiles:
                - $values/argo-apps/ingress-controller/values.yml
          - repoURL: "https://github.com/ZaiusDR/k8s_playground.git"
            targetRevision: HEAD
            ref: values
        syncPolicy:
          automated:
            selfHeal: true
          syncOptions:
            - ApplyOutOfSyncOnly=true

apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: argocd-server
  namespace: argocd
spec:
  entryPoints:
    - web
  routes:
    - kind: Rule
      match: PathPrefix(`/`)
      priority: 10
      services:
        - name: argocd-server
          port: 80
