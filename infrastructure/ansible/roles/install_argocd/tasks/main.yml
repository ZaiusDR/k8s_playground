---
- name: Add ArgoCD Helm Repo
  kubernetes.core.helm_repository:
    name: argocd
    repo_url: "https://argoproj.github.io/argo-helm"

- name: Install ArgoCD Helm Chart
  kubernetes.core.helm:
    name: argocd
    chart_ref: argocd/argo-cd
    update_repo_cache: true
    release_namespace: argocd
    create_namespace: true
    wait: true
    atomic: true
    values:
      configs:
        params:
          server.insecure: true

- name: Install App-of-apps
  kubernetes.core.k8s:
    definition:
      apiVersion: argoproj.io/v1alpha1
      kind: Application
      metadata:
        name: app-of-apps
        namespace: argocd
        finalizers:
          - resources-finalizer.argocd.argoproj.io
      spec:
        destination:
          namespace: argocd
          server: https://kubernetes.default.svc
        project: default
        source:
          path: apps/argo-apps
          repoURL: https://github.com/ZaiusDR/k8s_playground/
          targetRevision: HEAD
        syncPolicy:
          automated:
            selfHeal: true
          syncOptions:
            - CreateNamespace=true
            - ApplyOutOfSyncOnly=true
